name: Deploy

on:
    push:
        branches:
            - master

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
#            - uses: chrnorm/deployment-action@releases/v1
#              name: Create GitHub deployment
#              id: github_deploy
#              with:
#                  initial_status: "in_progress"
#                  token: "${{ github.token }}"
#                  environment: prod

            - uses: actions/checkout@v2

            - name: Log into registry
              run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

            - name: Build and push image
              run: |
                  # Cache multi-stage builds: https://pythonspeed.com/articles/faster-multi-stage-builds/
                  # this image does not exist
#                  docker pull rector/cleaningladylist.com:base || true
#                  docker pull rector/cleaningladylist.com:node-build || true
#                  docker pull rector/cleaningladylist.com:latest || true

                  docker build . --tag rector/cleaningladylist.com:base --target base \
                    --cache-from rector/cleaningladylist.com:base

                  docker build . --tag rector/cleaningladylist.com:node-build --target node-build \
                    --cache-from rector/cleaningladylist.com:base \
                    --cache-from rector/cleaningladylist.com:node-build

                  docker build . --tag rector/cleaningladylist.com:latest --target production \
                    --build-arg commitHash=${{ github.sha }} \
                    --cache-from rector/cleaningladylist.com:base \
                    --cache-from rector/cleaningladylist.com:node-build \
                    --cache-from rector/cleaningladylist.com:latest

                  docker push rector/cleaningladylist.com:base
                  docker push rector/cleaningladylist.com:node-build
                  docker push rector/cleaningladylist.com:latest

            # see https://github.com/appleboy/ssh-action
            - name: Deploy
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.DEPLOY_HOST }}
                  username: ${{ secrets.DEPLOY_USERNAME }}
                  key: ${{ secrets.DEPLOY_KEY }}
                  script: "cd /projects/cleaningladylist.com && ./run.sh"

#            - name: Update GitHub deployment status (success)
#              if: success()
#              uses: chrnorm/deployment-status@releases/v1
#              with:
#                  token: "${{ github.token }}"
#                  state: "success"
#                  deployment_id: ${{ steps.github_deploy.outputs.deployment_id }}

#            - name: Update GitHub deployment status (failure)
#              if: failure()
#              uses: chrnorm/deployment-status@releases/v1
#              with:
#                  token: "${{ github.token }}"
#                  state: "failure"
#                  deployment_id: ${{ steps.github_deploy.outputs.deployment_id }}
